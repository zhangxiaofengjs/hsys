<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hsys.mappers.AttendanceMapper">
	<resultMap id="userResultMap" type="userModel" >  
        <id column="u_id" property="id"/>  
        <result column="u_name" property="name"/>
        <result column="u_no" property="no"/>    
    </resultMap>
 
	<resultMap id="attendanceResultMap" type="attendanceModel" >  
        <id column="a_id" property="id"/>  
        <result column="a_start" property="start"/>  
        <result column="a_end" property="end"/>  
        <result column="a_date" property="date"/>  
        <result column="a_comment" property="comment"/>  
        <association property="user" resultMap="userResultMap"/> 
    </resultMap>

	<select id="queryList" resultMap="attendanceResultMap">
		select a.c_id as a_id,
			   a.c_start as a_start,
			   a.c_end as a_end,
			   a.c_date as a_date,
			   a.c_comment as a_comment,
			   u.c_id as u_id,
			   u.c_name as u_name,
			   u.c_no as u_no
		from attendance_tbl as a
		left join user_tbl as u on u.c_id=a.c_user_id
		left join user_group_tbl as ug on ug.c_user_id=a.c_user_id
		<where>
			<if test="cond.userId != null">
				and a.c_user_id = #{user.id}
			</if>
			<if test="cond.date != null">
				and a.c_date = #{date}
			</if>
			<if test="cond.userNo != null">
				<choose>
	                <when  test="cond.fuzzyUserNo != null">
			   			and u.c_no like '%${user.no}%'
			   		</when>
			   		<otherwise>
			   			and u.c_no = #{user.no}
			   		</otherwise>
				</choose>
			</if>
			<if test="cond.startDate != null">
				and a.c_date <![CDATA[ >= ]]> #{cond.startDate}
			</if>
			<if test="cond.endDate != null">
				and a.c_date <![CDATA[ <= ]]> #{cond.endDate}
			</if>
			<if test="cond.groupId != null">
				and ug.c_group_id = #{cond.groupId}
			</if>
		</where>
		order by a.c_user_id, a.c_date
	</select>

	<insert id="add" parameterType="attendanceModel">
    	insert into attendance_tbl (
    		c_user_id,
    		c_start,
    		c_end,
    		c_date,
    		c_comment)
    	values (
    		#{user.id},
    		#{start},
    		#{end},
    		#{date},
    		#{comment}
    	)
      	<selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
      		select LAST_INSERT_ID() as id
      	</selectKey>
    </insert>
    
	<update id="update">
    	update attendance_tbl
		<set>
    		<if test="update.start != null">
				c_start = #{start},
			</if>
    		<if test="update.end != null">
				c_end = #{end},
			</if>
    		<if test="update.comment != null">
				c_comment = #{comment},
			</if>
		</set>
    	<where>
			<if test="cond.userId != null">
				and c_user_id = #{user.id}
			</if>
			<if test="cond.date != null">
				and c_date = #{date}
			</if>
		</where>
    </update>
</mapper>